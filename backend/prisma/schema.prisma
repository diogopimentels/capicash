// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- 1. USUÁRIOS & ASSINATURAS ---

model User {
  id          String   @id // ID vindo do Clerk (ex: user_2N...)
  email       String   @unique
  name        String?
  avatarUrl   String?  @map("avatar_url")
  pixKey      String?  @map("pix_key")
  pixKeyType  String?  @map("pix_key_type") // CPF, EMAIL, PHONE, RANDOM
  
  plan        PlanType @default(FREE)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  products         Product[]
  transactions     Transaction[]     @relation("SellerTransactions")
  withdrawals      Withdrawals[]
  balance          Balance?

  @@map("users")
}

enum PlanType {
  FREE
  CREATOR
  PRO
}

// --- 2. PRODUTOS (LINKS) ---

model Product {
  id          String      @id @default(cuid())
  userId      String      @map("user_id")
  
  title       String
  description String?
  priceCents  Int         @map("price_cents") // Preço em Centavos (R$ 1,00 = 100)
  active      Boolean     @default(true)
  slug        String      @unique // [capicash.com/p/slug-do-produto](https://capicash.com/p/slug-do-produto)
  
  // Configurações do Produto
  redirectUrl String      @map("redirect_url") // O Link que será entregue
  imageUrl    String?     @map("image_url")    // Capa do produto
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relacionamentos
  user             User              @relation(fields: [userId], references: [id])
  checkoutSessions CheckoutSession[]
  transactions     Transaction[]

  @@map("products")
}

// --- 3. CHECKOUT & PAGAMENTOS ---

model CheckoutSession {
  id          String         @id @default(cuid())
  productId   String         @map("product_id")
  
  buyerEmail  String?        @map("buyer_email")
  status      CheckoutStatus @default(PENDING)
  amountCents Int            @map("amount_cents")
  
  // Dados do Gateway (Abacate Pay)
  gatewayId   String?        @map("gateway_id") // ID da cobrança na Abacate
  pixQrCode   String?        @map("pix_qr_code")
  pixCode     String?        @map("pix_code")   // Copia e Cola
  
  createdAt   DateTime       @default(now()) @map("created_at")
  paidAt      DateTime?      @map("paid_at")

  // Relacionamentos
  product      Product       @relation(fields: [productId], references: [id])
  transactions Transaction[]

  @@map("checkout_sessions")
}

enum CheckoutStatus {
  PENDING
  PAID
  EXPIRED
  FAILED
}

// --- 4. TRANSAÇÕES & LEDGER ---

model Transaction {
  id                String            @id @default(cuid())
  sessionId         String?           @map("session_id")
  sellerId          String            @map("seller_id")
  productId         String?           @map("product_id")
  
  amountCents       Int               @map("amount_cents") // Valor Bruto
  feeCents          Int               @map("fee_cents")    // Taxa Capicash
  netCents          Int               @map("net_cents")    // Valor Líquido (Saldo)
  
  status            TransactionStatus @default(CONFIRMED)
  createdAt         DateTime          @default(now()) @map("created_at")

  // Relacionamentos
  session CheckoutSession? @relation(fields: [sessionId], references: [id])
  seller  User             @relation("SellerTransactions", fields: [sellerId], references: [id])
  product Product?         @relation(fields: [productId], references: [id])

  @@map("transactions")
}

enum TransactionStatus {
  CONFIRMED
  REFUNDED
}

// --- 5. SALDO & SAQUES ---

model Balance {
  userId         String   @id @map("user_id")
  availableCents Int      @default(0) @map("available_cents") // Saldo Livre
  pendingCents   Int      @default(0) @map("pending_cents")   // Saldo Futuro (se houver D+X)
  updatedAt      DateTime @default(now()) @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@map("balances")
}

model Withdrawals {
  id           String         @id @default(cuid())
  userId       String         @map("user_id")
  amountCents  Int            @map("amount_cents")
  status       WithdrawStatus @default(REQUESTED)
  
  pixKey       String         @map("pix_key")
  processedAt  DateTime?      @map("processed_at")
  createdAt    DateTime       @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("withdrawals")
}

enum WithdrawStatus {
  REQUESTED
  PROCESSING
  PAID
  FAILED
}
